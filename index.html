<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Fishing Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;padding:0;overflow:hidden;background:black;touch-action:none}

/* UI */
#money{
 position:fixed;bottom:10px;right:10px;
 color:white;font-size:18px;
 background:rgba(0,0,0,.5);
 padding:6px 10px;border-radius:6px
}
#book{
 position:fixed;top:10px;left:10px;
 font-size:28px;cursor:pointer;
 z-index:10
}
#rules{
 position:fixed;top:50%;left:50%;
 transform:translate(-50%,-50%);
 width:85%;max-width:420px;
 background:rgba(0,0,0,.9);
 color:white;padding:20px;
 border-radius:12px;
 display:none;
 z-index:20
}
#rules button{
 margin-top:12px;padding:6px 14px;
 font-size:16px
}
#msg{
 position:fixed;top:50%;left:50%;
 transform:translate(-50%,-50%);
 color:white;font-size:22px;
 display:none;text-shadow:2px 2px 5px black
}

/* Controls */
#joystick{position:fixed;bottom:120px;left:20px;width:110px;height:110px;background:rgba(255,255,255,.15);border-radius:50%}
#stick{position:absolute;left:30px;top:30px;width:50px;height:50px;background:white;border-radius:50%}
#jump{position:fixed;bottom:120px;right:20px;width:80px;height:80px;border-radius:50%}

/* INVENTORY */
#inventory{
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  overflow-x: auto;
  max-width: 90%;
  padding: 6px;
  background: rgba(0,0,0,.3);
  border-radius: 6px;
}
.slot{
  width: 42px;
  height: 42px;
  border: 2px solid white;
  color: white;
  font-size: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.5);
  flex: 0 0 auto;
}
.slot.active{border-color: yellow}

/* SHOP */
#shop{
 position:fixed;
 top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:rgba(0,0,0,.9);
 color:white;
 padding:20px;
 border-radius:12px;
 display:none;
 z-index:50;
 text-align:center
}
#shop button{
 margin:6px;
 padding:6px 14px;
 font-size:16px
}

/* LOGIN */
#login{
 position:fixed;
 top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:rgba(0,0,0,.9);
 color:white;
 padding:20px;
 border-radius:12px;
 z-index:100;
 text-align:center;
}
#login input{
 padding:6px 10px;
 font-size:16px;
 margin-bottom:12px;
}
#login button{
 padding:6px 14px;
 font-size:16px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
 <h2>Login</h2>
 <input type="text" id="username" placeholder="Enter username"><br>
 <button id="loginBtn">Login</button>
</div>

<div id="book">ðŸ“˜</div>

<div id="rules">
 <h2>Fishing Game Rules</h2>
 <p>
 ðŸŽ® Controls<br>
 â€¢ Move with joystick<br>
 â€¢ Swipe to look<br>
 â€¢ Jump button<br><br>

 ðŸŽ£ Fishing<br>
 â€¢ Equip a rod<br>
 â€¢ Hold 2s to cast<br>
 â€¢ Tap fast to catch<br><br>

 ðŸ’° Selling<br>
 â€¢ Tap fish once to preview<br>
 â€¢ Double tap to sell
 </p>
 <button onclick="rules.style.display='none'">CLOSE</button>
</div>

<div id="money">$0</div>
<div id="msg"></div>

<div id="joystick"><div id="stick"></div></div>
<button id="jump">JUMP</button>
<div id="inventory"></div>

<!-- SHOP -->
<div id="shop">
 <h3>Shop</h3>
 <button id="buySunRod">Buy Sun Rod ($1000)</button><br><br>
 <button onclick="shop.style.display='none'">CLOSE</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
/* ===== SCENE ===== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87CEEB);

const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,1000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,.7));
const sun=new THREE.DirectionalLight(0xffffff,1);
sun.position.set(10,20,10);
scene.add(sun);

/* PLAYER */
const player=new THREE.Object3D();
scene.add(player);
player.position.set(0,3,0);
player.add(camera);

let yaw=0,pitch=0;

/* ===== INVENTORY SYSTEM ===== */
let money=0;
const prices={Clownfish:5,Tuna:10,Shark:25,Pufferfish:25,SeaTurtle:50,MantaRay:500,Megalodon:1000};

const rods=[
 "Rod",
 "Sun Rod",
 "Moon Rod",
 "Ocean Rod",
 "Storm Rod",
 "Frost Rod",
 "Flame Rod",
 "Nature Rod",
 "Void Rod"
];

let inventory=["Rod","","","","","","","",""];
let selected=0;
let lastTapTime=0;

function parseStack(item){
 if(!item) return {name:"",count:0};
 const m=item.match(/^(.+)x(\\d+)$/);
 if(m) return {name:m[1],count:+m[2]};
 return {name:item,count:1};
}

function renderInv(){
 inventoryDiv.innerHTML="";
 inventory.forEach((it,i)=>{
  const d=document.createElement("div");
  d.className="slot"+(i===selected?" active":"");
  d.textContent=it;
  d.onclick=()=>slotTap(i);
  inventoryDiv.appendChild(d);
 });
}

const inventoryDiv=document.getElementById("inventory");
renderInv();

function slotTap(index){
 const {name,count}=parseStack(inventory[index]);
 selected=index;
 renderInv();
 updateRod();

 if(!name || rods.includes(name)) return;

 const now=Date.now();
 if(lastTapTime && now-lastTapTime<500){
  money+=(prices[name]||0)*count;
  inventory[index]="";
  document.getElementById("money").textContent="$"+money;
  renderInv();
  lastTapTime=0;
 }else{
  msg.style.display="block";
  msg.textContent=name+" (double tap to sell)";
  setTimeout(()=>msg.style.display="none",1000);
  lastTapTime=now;
 }
}
 /* ===== ROD VISUAL ===== */
let rod=null;
function updateRod(){
 if(rods.includes(inventory[selected])){
  if(!rod){
   rod=new THREE.Mesh(
    new THREE.CylinderGeometry(.02,.02,1),
    new THREE.MeshStandardMaterial({color:0xffcc00})
   );
   rod.position.set(.3,-.4,-1);
   rod.rotation.z=Math.PI/4;
   camera.add(rod);
  }
 }else if(rod){
  camera.remove(rod);
  rod=null;
 }
}

/* ===== SHOP LOGIC ===== */
buySunRod.onclick=()=>{
 if(money<1000)return alert("Not enough money");
 for(let i=0;i<inventory.length;i++){
  if(inventory[i]===""){
   inventory[i]="Sun Rod";
   money-=1000;
   document.getElementById("money").textContent="$"+money;
   renderInv();
   return;
  }
 }
 alert("Inventory full!");
};

/* ===== FISHING MINI-GAME ===== */
let holding=false,holdTime=0,fishing=false;
let taps=0,requiredTaps=10;
let fishButton=null,fishTimer=null;

addEventListener("touchstart",()=>{
 if(rods.includes(inventory[selected])&&!fishing){
  holding=true;holdTime=0;
 }
});
addEventListener("touchend",()=>{
 holding=false;holdTime=0;
});

function randomFish(){
 const r=Math.random();
 if(r<1/50)return "Megalodon";
 if(r<1/25)return "MantaRay";
 if(r<1/5)return "SeaTurtle";
 if(r<1/3)return "Pufferfish";
 if(r<0.58)return "Tuna";
 if(r<0.83)return "Clownfish";
 return "Shark";
}

function createFishButton(){
 fishButton=document.createElement("button");
 fishButton.textContent="PRESS HERE!";
 fishButton.style.position="fixed";
 fishButton.style.left=Math.random()*(innerWidth-150)+"px";
 fishButton.style.top=Math.random()*(innerHeight-60)+"px";
 fishButton.style.padding="12px 20px";
 fishButton.style.fontSize="18px";
 fishButton.style.zIndex="200";
 document.body.appendChild(fishButton);
}

function startFishing(){
 fishing=true;
 taps=0;
 msg.style.display="block";
 msg.textContent="Casting...";
 setTimeout(()=>{
  const fish=randomFish();
  msg.textContent=fish+"! Catch it!";
  function fail(){
   fishing=false;
   msg.textContent="Fish escaped!";
   if(fishButton)fishButton.remove();
   setTimeout(()=>msg.style.display="none",1500);
  }
  function next(){
   if(taps>=requiredTaps){
    inventory.push(fish);
    msg.textContent="Caught "+fish+"!";
    renderInv();
    fishing=false;
    if(fishButton)fishButton.remove();
    setTimeout(()=>msg.style.display="none",1500);
    return;
   }
   createFishButton();
   fishTimer=setTimeout(fail,1000);
   fishButton.onclick=()=>{
    taps++;
    clearTimeout(fishTimer);
    fishButton.remove();
    next();
   };
  }
  next();
 },1200);
}

/* ===== LOGIN SAVE SYSTEM ===== */
const loginDiv=document.getElementById("login");
const usernameInput=document.getElementById("username");
let username=null;

function save(){
 if(!username)return;
 localStorage.setItem("fishing_"+username,JSON.stringify({money,inventory,selected}));
}
function load(name){
 const d=localStorage.getItem("fishing_"+name);
 if(!d)return;
 const p=JSON.parse(d);
 money=p.money||0;
 inventory=p.inventory||inventory;
 selected=p.selected||0;
 document.getElementById("money").textContent="$"+money;
 renderInv();
}

loginBtn.onclick=()=>{
 username=usernameInput.value.trim();
 if(!username)return alert("Enter name");
 load(username);
 loginDiv.style.display="none";
};
setInterval(save,5000);

/* ===== GAME LOOP ===== */
function animate(){
 requestAnimationFrame(animate);
 if(holding&&!fishing){
  holdTime+=.016;
  if(holdTime>=2){
   startFishing();
   holding=false;
  }
 }
 renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>

